# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
# hadoint is a Dockerfile linter written in Haskell
# that helps you build best practice Docker images.
# More details at https://github.com/hadolint/hadolint

name: Monitoring

on:
  push:
    branches: [ "master" ]
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [ "master" ]
  
permissions:
  contents: read
  issues: write

jobs:
  hadolint:
    name: Run hadolint scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read # for actions/checkout to fetch code
      security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
      actions: read # only required for a private repository by github/codeql-action/upload-sarif to get the Action run status
      issues: write # allow creating issues from SARIF results
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Run hadolint
        uses: hadolint/hadolint-action@2332a7b74a6de0dda2e2221d575162eba76ba5e5
        with:
          dockerfile: ".devcontainer/Dockerfile"
          format: sarif
          output-file: hadolint-results.sarif
          no-fail: true

      - name: Upload analysis results to GitHub
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: hadolint-results.sarif
          wait-for-processing: true

      - name: Create GitHub issues from hadolint SARIF
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'hadolint-results.sarif';
            if (!fs.existsSync(path)) {
              console.log(`SARIF file not found: ${path}`);
              return;
            }
            const sarif = JSON.parse(fs.readFileSync(path, 'utf8'));
            const runs = sarif.runs || [];
            const findings = [];
            for (const run of runs) {
              const results = run.results || [];
              for (const r of results) {
                const ruleId = r.ruleId || (r.rule && r.rule.id) || 'hadolint';
                const message = r.message && (r.message.text || r.message.markdown) || 'No message';
                const location = (r.locations && r.locations[0] && r.locations[0].physicalLocation && r.locations[0].physicalLocation.artifactLocation && r.locations[0].physicalLocation.artifactLocation.uri) || '.devcontainer/Dockerfile';
                const startLine = r.locations && r.locations[0] && r.locations[0].physicalLocation && r.locations[0].physicalLocation.region && r.locations[0].physicalLocation.region.startLine;
                findings.push({ruleId, message, location, startLine});
              }
            }
            const grouped = {};
            for (const f of findings) {
              const key = `${f.ruleId}|${f.location}|${f.startLine || ''}`;
              if (!grouped[key]) grouped[key] = f;
            }
            const { data: existing } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'hadolint'
            });
            const seenTitles = new Set(existing.map(i => i.title));
            for (const key of Object.keys(grouped)) {
              const f = grouped[key];
              const title = `hadolint: ${f.ruleId} in ${f.location}${f.startLine ? `:${f.startLine}` : ''}`;
              if (seenTitles.has(title)) {
                console.log(`Issue already exists: ${title}`);
                continue;
              }
              const body = `**hadolint rule:** ${f.ruleId}\n\n**Location:** ${f.location}${f.startLine ? `:${f.startLine}` : ''}\n\n**Message:**\n${f.message}\n\n> Automatically created by workflow \`monitoring.yml\`.`;
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['hadolint','automation']
              });
              console.log(`Created issue: ${title}`);
            }
  linkChecker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Link Checker
        uses: lycheeverse/lychee-action@v2.6.1
        with:
          fail: true
          args: --base . --verbose --no-progress './hugo/content/**/*.md' --exclude '.*RelPermalink.*'